<app-navbar></app-navbar>

<section class="gestion-wrapper">

  <div class="gestion-card">

    <h1 class="title">⚙️ Gestionar Brigadas</h1>
    <p class="subtitle">
      Agrega usuarios autorizados (excepto administradores y jefes de brigada) y herramientas a una brigada seleccionada.
    </p>

    <!-- ESTADOS GENERALES -->
    <div *ngIf="cargando" class="estado info">Cargando brigadas...</div>
    <div *ngIf="!cargando && error" class="estado error">{{ error }}</div>
    <div *ngIf="!cargando && !error && !brigadas.length" class="estado info">
      No hay brigadas registradas.
    </div>

    <div class="acciones-superiores">
      <button class="btn primario" type="button" (click)="abrirFormularioHerramientas()">
        Herramientas
      </button>
    </div>

    <!-- TABLA DE BRIGADAS -->
    <div class="table-wrapper" *ngIf="!cargando && brigadas.length">

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Departamento</th>
            <th>Conglomerado</th>
            <th>Fecha</th>
            <th>Líder</th>
            <th>Acción</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let b of brigadas">
            <td>#{{ b.id_brigada }}</td>
            <td>{{ b.departamento }}</td>
            <td>{{ b.id_conglomerado || 'Sin asignar' }}</td>
            <td>{{ b.fecha_asignacion || 'Sin fecha' }}</td>
            <td>{{ b.lider }}</td>
            <td>
              <button class="btn secundario" (click)="abrirGestion(b)">
                Gestionar
              </button>
            </td>
          </tr>
        </tbody>

      </table>

    </div>

  </div>

  <!-- ================================== -->
  <!-- MODAL DE GESTIÓN                   -->
  <!-- ================================== -->
  <div class="modal-backdrop" *ngIf="selectedBrigada">

    <div class="modal">

      <button class="cerrar" (click)="cerrarGestion()">×</button>

      <h2>Brigada #{{ selectedBrigada?.id_brigada }}</h2>
      <p class="subtitulo">Selecciona los recursos para asignar.</p>

      <div class="acciones">

        <!-- INTEGRANTE -->
        <div class="campo">
          <label for="auxiliarSelect">Usuario</label>

          <div class="dropdown">
            <select id="auxiliarSelect" [(ngModel)]="auxiliarSeleccionado">
              <option value="" disabled>Selecciona un usuario</option>
              <option *ngFor="let aux of auxiliares" 
                      [value]="aux.nro_documento">
                {{ aux.nombre }} {{ aux.apellido }} — {{ aux.nro_documento }} ({{ aux.rol }})
              </option>
            </select>

            <button class="btn primario" (click)="agregarAuxiliar()">
              Agregar
            </button>
          </div>
        </div>

        <!-- HERRAMIENTA -->
        <div class="campo">
          <label for="herramientaSelect">Herramienta</label>

          <div class="dropdown">
            <select id="herramientaSelect" [(ngModel)]="herramientaSeleccionada">
              <option value="" disabled>Selecciona una herramienta</option>
              <option *ngFor="let h of herramientas" [value]="h.id_herramienta">
                {{ h.nombre }}
              </option>
            </select>

            <button class="btn primario" (click)="agregarHerramienta()">
              Agregar
            </button>
          </div>
        </div>

      </div>

      <!-- MENSAJE -->
      <div class="estado" 
           *ngIf="mensaje"
           [ngClass]="{ 'exito': tipoMensaje === 'exito', 'error': tipoMensaje === 'error' }">

        {{ mensaje }}

      </div>

    </div>
  </div>

</section>

<!-- Modal Herramientas -->
<div class="modal-backdrop" *ngIf="mostrarFormularioHerramienta">
  <div class="modal">
    <button class="cerrar" (click)="cerrarFormularioHerramientas()">&times;</button>

    <h2>Nueva herramienta</h2>
    <p class="subtitulo">
      Completa la información para registrar una herramienta disponible.
    </p>

    <form class="formulario-herramienta" (ngSubmit)="crearHerramienta()">
      <label>
        Nombre
        <input type="text" name="nombreHerramienta" [(ngModel)]="nuevaHerramienta.nombre" placeholder="Ej. Cinta métrica" required />
      </label>

      <label>
        Descripción
        <textarea name="descripcionHerramienta" [(ngModel)]="nuevaHerramienta.descripcion" rows="3" placeholder="Describe el uso y estado" required></textarea>
      </label>

      <label>
        Cantidad disponible
        <input type="number" name="cantidadDisponible" min="0" [(ngModel)]="nuevaHerramienta.cantidad_disponible" required />
      </label>

      <div class="estado"
           *ngIf="mensajeHerramienta"
           [ngClass]="{ 'exito': tipoMensajeHerramienta === 'exito', 'error': tipoMensajeHerramienta === 'error' }">
        {{ mensajeHerramienta }}
      </div>

      <div class="acciones-form">
        <button class="btn secundario" type="button" (click)="cerrarFormularioHerramientas()">Cancelar</button>
        <button class="btn primario" type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>
